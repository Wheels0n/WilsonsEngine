# 후처리 CS

## 감마 보정

![감마 그래프](https://learnopengl.com/img/advanced-lighting/gamma_correction_gamma_curves.png)  
과거 CRT모니터 시절에는 전압을 2배로 올린다고 밝기도 2배가 되는 게 아니었다. 대신에  
2.2 제곱, 모니터의 감마라고도 하는, 만큼 올라갔다고 한다. 정말 우연히도 이게  
인간이 밝기를 인식하는 방식과 매우 흡사하다는 것이다. 이러한 이유로 오늘날까지도  
원래의 물리적 밝기대신에 이렇게 비선형적인 방식을 취한다. 문제는 이렇게 화면에  
나오는 결과를 바탕으로 작업을 진행기 때문에 물리적으로 올바르지 못하다.

이러한 문제를 해결할 방법이 감마 보정이다. 감마보정은 화면으로 픽셀을 출력하기 전에
각 색상 값에 모니터의 감마의 역수를 지수로 하여 제곱해주면 된다. 이 2.2라는 감마 값은
대부분의 모니터의 평균적인 감마값에 유의해야한다.

sRGB는 대략 2.2의 감마를 가진 색 영역이며, 대부분의 기기들의 표준으로 쓰인다.
그러니 여기다가 모르고 또 감마 보정을 해주면 선형적이지 않게 되니 유의

## 톤 매핑

밝기 및 색상 값은 프레임 버퍼에 저장될 때 [0.0, 1.0] 사이로 clamped된다.  
만약 광원이 여러개 가있어서 밝기가 1.0f을 넘긴다면?

![LDR에서 1.0f초과](https://learnopengl.com/img/advanced-lighting/hdr_clamped.png)

다수의 색들이 1.0f으로 제한되어 죄다 같은 흰색으로 바뀐다. 이로인해 비현실적으로 변한다.  
이에 대한 대안으로 광원의 밝기를 제한 하는 방법이 있지만 이는 현실적이지 못한 광원 변수를  
쓰도록 강요한다. 더 좋은 방법으로는 일시적으로 1.0f을 초과하되 마지막에 다시 [0.0, 1.0]  
으로 되돌리는 것이다. HDR이 아닌 모니터들은 [0.0, 1.0]으로 색상값이 제한되지만 광원 계산  
시에는 그런 제약이 없다. 이러한 픽셀 값을 1.0이상을 초과하게 하여 더 넓은 범위의 색상 값을  
가지게 하는 기법이 HDR이다. 이를 통해 어두운 건 어둡게 밝은건 밝게 할 수가 있다.

HDR은 원래 사진사들에 의해 쓰였으며, 같은 장면을 노출도(exposure)를 다르게 하여 여러 장을  
찍어서 큰 범위의 색상 값을 취한다. 이들을 합쳐서 HDR이미지를 형성한다.

![노출도에 따른 차이](https://learnopengl.com/img/advanced-lighting/hdr_image.png)

노출도에 따라 나타나고 사라지는 세부 사항이 달라진다. 이는 인간의 눈이 작동하는 방식과  
유사하며 HDR의 기반이 된다.

HDR범위로 렌더링 하고 다시 LDR[0.0, 1.0]으로 다시 되돌리는 걸 톤 매핑이라고 한다.  
이 알고리즘 구현 방식도 한두개가 아니다. 어쩄든 이러한 복구에도 HDR에서의 디테일을  
잃지 않게 하는 게 핵심이다. 또한 어떤 밝기 부분을 더 선호할지 선택하는 exposore변수  
도 요구된다. HDR을 담기위해 16/32비트의 부동소수점 버퍼에 임시로 담아야한다.

![exposure변수를 통한 조절](https://learnopengl.com/img/advanced-lighting/hdr_exposure.png)

### 기타 변경사항

- Final ~~마지막에 적용한다하여 막 지었던 이름...~~ 이란 용어 대신에 지금부터라도 후처리라는 표현을 쓰기로함.
- 후처리 pass를 CS로 변경. 그에 따른 코드 수정.
- m_pViewportTex를 UAV로 변경

#### 출처

- [LearnOpenGL - 감마보정](https://learnopengl.com/Advanced-Lighting/Gamma-Correction)
- [LearnOpenGL - HDR](https://learnopengl.com/Advanced-Lighting/HDR)
